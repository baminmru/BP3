Ext.require(["Ext.form.*"]);function DefineInterface_groups_(i,j){var h=Ext.create("Ext.grid.feature.Grouping",{groupByText:"Группировать по этому полю",showGroupsText:"Показать группировку"});var f;function c(q){if(q){Ext.Ajax.request({url:rootURL+"index.php/c_groupuser/deleteRow",method:"POST",params:{groupuserid:q.get("groupuserid")}});f.store.remove(q)}}function b(){if(f.parentid=="{00000000-0000-0000-0000-000000000000}"){return}var q=f.getView().getSelectionModel().getSelection()[0];if(q){if(CheckOperation("MTZUsers.edit")!=0){Ext.Msg.show({title:"Удалить?",msg:"Удалить строку из базы данных?",buttons:Ext.Msg.YESNO,icon:Ext.window.MessageBox.QUESTION,fn:function(r,t,s){if(r=="yes"){c(s.selectedRow)}},caller:f,selectedRow:q})}else{Ext.MessageBox.show({title:"Контроль прав.",msg:"Удаление строк не разрешено!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}}}function a(){if(f.parentid=="{00000000-0000-0000-0000-000000000000}"){return}if(CheckOperation("MTZUsers.edit")!=0){var q=Ext.create("EditWindow_groupuser");f.store.insert(0,new model_groupuser());record=f.store.getAt(0);record.set("parentid",f.parentid);q.getComponent(0).setActiveRecord(record,f.instanceid,f.parentid);q.show()}else{Ext.MessageBox.show({title:"Контроль прав.",msg:"Создание строк не разрешено!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}}function e(){if(f.parentid=="{00000000-0000-0000-0000-000000000000}"){return}f.store.load({params:{parentid:f.parentid}})}function d(){if(f.parentid=="{00000000-0000-0000-0000-000000000000}"){return}var r=f.getView().getSelectionModel().getSelection()[0];if(r){if(CheckOperation("MTZUsers.edit")!=0){var q=Ext.create("EditWindow_groupuser");q.getComponent(0).setActiveRecord(r,f.instanceid,f.parentid);q.show()}else{Ext.MessageBox.show({title:"Контроль прав.",msg:"Изменение строк не разрешено!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}}}f=new Ext.grid.Panel({itemId:"grd_groupuser",minHeight:200,maxHeight:1200,iconCls:"icon-grid",frame:true,parentid:"{00000000-0000-0000-0000-000000000000}",title:"Состав группы",scroll:"both",stateful:stateFulSystem,stateId:"groupuser",store:{model:"model_groupuser",autoLoad:false,autoSync:false,proxy:{type:"ajax",url:rootURL+"index.php/c_groupuser/getRows",reader:{type:"json",root:"data",successProperty:"success",messageProperty:"msg"},listeners:{exception:function(r,s,q){}}}},features:[h],dockedItems:[{xtype:"toolbar",items:[{iconCls:"icon-application_form_add",text:"Создать",scope:this,handler:a},{iconCls:"icon-application_form_edit",text:"Изменить",scope:this,disabled:true,itemId:"edit",handler:d},{iconCls:"icon-application_form_delete",text:"Удалить",disabled:true,itemId:"delete",scope:this,handler:b},{iconCls:"icon-table_refresh",text:"Обновить",itemId:"bRefresh",scope:this,handler:e}]}],columns:[{text:"Пользователь",width:200,dataIndex:"theuser_grid",sortable:true}],listeners:{itemdblclick:function(){d()},itemclick:function(r,q){f.down("#delete").setDisabled(false);f.down("#edit").setDisabled(false)},select:function(t,s,r,q){f.down("#delete").setDisabled(false);f.down("#edit").setDisabled(false)},selectionchange:function(r,q){f.down("#delete").setDisabled(q.length===0);f.down("#edit").setDisabled(q.length===0)}}});var g=Ext.create("Ext.grid.feature.Grouping",{groupByText:"Группировать по этому полю",showGroupsText:"Показать группировку"});var p;function m(q){if(q){Ext.Ajax.request({url:rootURL+"index.php/c_groups/deleteRow",method:"POST",params:{groupsid:q.get("groupsid")}});p.store.remove(q)}}function l(){var q=p.getView().getSelectionModel().getSelection()[0];if(q){if(CheckOperation("MTZUsers.edit")!=0){Ext.Msg.show({title:"Удалить?",msg:"Удалить строку из базы данных?",buttons:Ext.Msg.YESNO,icon:Ext.window.MessageBox.QUESTION,fn:function(r,t,s){if(r=="yes"){m(s.selectedRow)}},caller:this,selectedRow:q})}else{Ext.MessageBox.show({title:"Контроль прав.",msg:"Удаление строк не разрешено!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}}}function k(){if(CheckOperation("MTZUsers.edit")!=0){var q=Ext.create("EditWindow_groups");p.store.insert(0,new model_groups());record=p.store.getAt(0);record.set("instanceid",p.instanceid);q.getComponent(0).setActiveRecord(record,p.instanceid);q.show()}else{Ext.MessageBox.show({title:"Контроль прав.",msg:"Создание строк не разрешено!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}}function o(){p.store.load({params:{instanceid:p.instanceid}})}function n(){var r=p.getView().getSelectionModel().getSelection()[0];if(r){if(CheckOperation("MTZUsers.edit")!=0){var q=Ext.create("EditWindow_groups");q.getComponent(0).setActiveRecord(r,r.get("instanceid"));q.show()}else{Ext.MessageBox.show({title:"Контроль прав.",msg:"Изменение строк не разрешено!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}}}p=new Ext.grid.Panel({itemId:i,store:j,frame:true,instanceid:"",scroll:"both",autoScroll:true,width:600,features:[g],dockedItems:[{xtype:"toolbar",items:[{iconCls:"icon-application_form_add",text:"Создать",scope:this,handler:k},{iconCls:"icon-application_form_edit",text:"Изменить",scope:this,disabled:true,itemId:"edit",handler:n},{iconCls:"icon-application_form_delete",text:"Удалить",disabled:true,itemId:"delete",scope:this,handler:l},{iconCls:"icon-table_refresh",text:"Обновить",itemId:"bRefresh",scope:this,handler:o}]}],columns:[{text:"Название",width:200,dataIndex:"name",sortable:true},{text:"Группа AD",width:200,dataIndex:"adgroup",sortable:true}],bbar:f,listeners:{resize:function(u,v,r,t,s,q){f.setHeight(r*0.5)},render:function(q){q.store.on("load",function(t,s,r){if(t.count()>0){q.getSelectionModel().select(0)}})},itemdblclick:function(){n()},itemclick:function(r,q){p.down("#delete").setDisabled(false);p.down("#edit").setDisabled(false);f.instanceid=p.instanceid;f.parentid=q.get("groupsid");f.store.load({params:{parentid:q.get("groupsid")}})},selectionchange:function(s,r){p.down("#delete").setDisabled(r.length===0);p.down("#edit").setDisabled(r.length===0);var q=r[0];if(q){p.down("#grd_groupuser").instanceid=p.instanceid;p.down("#grd_groupuser").parentid=q.get("groupsid");p.down("#grd_groupuser").store.load({params:{parentid:q.get("groupsid")}})}}}});return p}function DefineForms_groups_(){Ext.define("Form_groups",{extend:"Ext.form.Panel",alias:"widget.f_groups",initComponent:function(){this.addEvents("create");Ext.apply(this,{activeRecord:null,defaultType:"textfield",x:0,fieldDefaults:{labelAlign:"top"},items:[{xtype:"panel",closable:false,title:"",preventHeader:true,id:"groups-0",layout:"absolute",border:false,items:[{minWidth:740,width:740,maxWidth:740,x:5,y:0,xtype:"textfield",value:"",name:"name",itemId:"name",fieldLabel:"Название",labelClsExtra:"x-item-mandatory",allowBlank:false,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:46,xtype:"textfield",value:"",name:"adgroup",itemId:"adgroup",fieldLabel:"Группа AD",allowBlank:true,labelWidth:120}],width:770,height:122}],instanceid:"",dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",items:["->",{iconCls:"icon-accept",itemId:"save",text:"Сохранить",disabled:true,scope:this,handler:this.onSave},{iconCls:"icon-cancel",text:"Закрыть",scope:this,handler:this.onReset}]}]});this.callParent()},setActiveRecord:function(b,a){this.activeRecord=b;this.instanceid=a;if(b){this.down("#save").enable();this.getForm().loadRecord(b)}else{this.down("#save").disable();this.getForm().reset()}},onSave:function(){var a=this.activeRecord,b=this.getForm();if(!a){return}if(b.isValid()){b.updateRecord(a);StatusDB("Сохранение данных");Ext.Ajax.request({url:rootURL+"index.php/c_groups/setRow",method:"POST",params:{instanceid:this.instanceid,groupsid:a.get("groupsid"),name:a.get("name"),adgroup:a.get("adgroup")},success:function(d){var e=d.responseText;var c=Ext.decode(e);if(c.success==false){Ext.MessageBox.show({title:"Ошибка",msg:c.msg,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});StatusErr("Ошибка. "+c.msg)}else{if(a.get("groupsid")==""){a.set("groupsid",c.data.groupsid)}StatusReady("Изменения сохранены");b.owner.ownerCt.close()}}})}else{Ext.MessageBox.show({title:"Ошибка",msg:"Не все обязательные поля заполнены!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}},onReset:function(){if(this.activeRecord.get("groupsid")==""){this.activeRecord.store.reload()}this.setActiveRecord(null,null);this.ownerCt.close()}});Ext.define("EditWindow_groups",{extend:"Ext.window.Window",maxHeight:227,maxWidth:900,autoScroll:true,minWidth:750,width:800,minHeight:197,height:197,constrainHeader:true,layout:"absolute",autoShow:true,modal:true,closable:false,closeAction:"destroy",iconCls:"icon-application_form",title:"Группы",items:[{xtype:"f_groups"}]});Ext.define("Form_groupuser",{extend:"Ext.form.Panel",alias:"widget.f_groupuser",initComponent:function(){this.addEvents("create");Ext.apply(this,{activeRecord:null,defaultType:"textfield",x:0,fieldDefaults:{labelAlign:"top"},items:[{xtype:"panel",closable:false,title:"",preventHeader:true,id:"groupuser-0",layout:"absolute",border:false,items:[{minWidth:740,width:740,maxWidth:740,x:5,y:0,xtype:"combobox",trigger1Cls:"x-form-select-trigger",hideTrigger1:false,onTrigger1Click:function(){if(this.isExpanded){this.collapse()}else{if(this.store.count(false)==0){this.store.load()}this.expand()}},editable:false,listeners:{select:function(a,c,b){a.up("form").activeRecord.set("theuser",c[0].get("id"))}},store:cmbstore_users,valueField:"brief",displayField:"brief",typeAhead:true,emptyText:"",name:"theuser_grid",itemId:"theuser_grid",fieldLabel:"Пользователь",labelClsExtra:"x-item-mandatory",allowBlank:false,labelWidth:120}],width:770,height:76}],instanceid:"",dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",items:["->",{iconCls:"icon-accept",itemId:"save",text:"Сохранить",disabled:true,scope:this,handler:this.onSave},{iconCls:"icon-cancel",text:"Закрыть",scope:this,handler:this.onReset}]}]});this.callParent()},setActiveRecord:function(c,a,b){this.activeRecord=c;this.instanceid=a;this.parentid=b;if(c){this.down("#save").enable();this.getForm().loadRecord(c)}else{this.down("#save").disable();this.getForm().reset()}},onSave:function(){var a=this.activeRecord,b=this.getForm();if(!a){return}if(b.isValid()){b.updateRecord(a);StatusDB("Сохранение данных");Ext.Ajax.request({url:rootURL+"index.php/c_groupuser/setRow",method:"POST",params:{instanceid:this.instanceid,parentid:this.parentid,groupuserid:a.get("groupuserid"),theuser:a.get("theuser")},success:function(d){var e=d.responseText;var c=Ext.decode(e);if(c.success==false){Ext.MessageBox.show({title:"Ошибка",msg:c.msg,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});StatusErr("Ошибка. "+c.msg)}else{if(a.get("groupuserid")==""){a.set("groupuserid",c.data.groupuserid)}StatusReady("Изменения сохранены");b.owner.ownerCt.close()}}})}else{Ext.MessageBox.show({title:"Ошибка",msg:"Не все обязательные поля заполнены!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}},onReset:function(){if(this.activeRecord.get("groupuserid")==""){this.activeRecord.store.reload()}this.setActiveRecord(null,null);this.ownerCt.close()}});Ext.define("EditWindow_groupuser",{extend:"Ext.window.Window",maxHeight:181,maxWidth:900,autoScroll:true,minWidth:750,width:800,minHeight:151,height:151,constrainHeader:true,layout:"absolute",autoShow:true,modal:true,closable:false,closeAction:"destroy",iconCls:"icon-application_form",title:"Состав группы",items:[{xtype:"f_groupuser"}]})};