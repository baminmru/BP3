Ext.require(["Ext.form.*"]);function DefineInterface_bp3app_modules_(i,j){var h=Ext.create("Ext.grid.feature.Grouping",{groupByText:"Группировать по этому полю",showGroupsText:"Показать группировку"});var f;function c(q){if(q){Ext.Ajax.request({url:rootURL+"index.php/c_bp3app_oper/deleteRow",method:"POST",params:{bp3app_operid:q.get("bp3app_operid")}});f.store.remove(q)}}function b(){if(f.parentid=="{00000000-0000-0000-0000-000000000000}"){return}var q=f.getView().getSelectionModel().getSelection()[0];if(q){if(CheckOperation("bp3app.edit")!=0){Ext.Msg.show({title:"Удалить?",msg:"Удалить строку из базы данных?",buttons:Ext.Msg.YESNO,icon:Ext.window.MessageBox.QUESTION,fn:function(r,t,s){if(r=="yes"){c(s.selectedRow)}},caller:f,selectedRow:q})}else{Ext.MessageBox.show({title:"Контроль прав.",msg:"Удаление строк не разрешено!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}}}function a(){if(f.parentid=="{00000000-0000-0000-0000-000000000000}"){return}if(CheckOperation("bp3app.edit")!=0){var q=Ext.create("EditWindow_bp3app_oper");f.store.insert(0,new model_bp3app_oper());record=f.store.getAt(0);record.set("parentid",f.parentid);q.getComponent(0).setActiveRecord(record,f.instanceid,f.parentid);q.show()}else{Ext.MessageBox.show({title:"Контроль прав.",msg:"Создание строк не разрешено!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}}function e(){if(f.parentid=="{00000000-0000-0000-0000-000000000000}"){return}f.store.load({params:{parentid:f.parentid}})}function d(){if(f.parentid=="{00000000-0000-0000-0000-000000000000}"){return}var r=f.getView().getSelectionModel().getSelection()[0];if(r){if(CheckOperation("bp3app.edit")!=0){var q=Ext.create("EditWindow_bp3app_oper");q.getComponent(0).setActiveRecord(r,f.instanceid,f.parentid);q.show()}else{Ext.MessageBox.show({title:"Контроль прав.",msg:"Изменение строк не разрешено!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}}}f=new Ext.grid.Panel({itemId:"grd_bp3app_oper",minHeight:200,maxHeight:1200,iconCls:"icon-grid",frame:true,parentid:"{00000000-0000-0000-0000-000000000000}",title:"Действия и отчеты",scroll:"both",stateful:stateFulSystem,stateId:"bp3app_oper",store:{model:"model_bp3app_oper",autoLoad:false,autoSync:false,proxy:{type:"ajax",url:rootURL+"index.php/c_bp3app_oper/getRows",reader:{type:"json",root:"data",successProperty:"success",messageProperty:"msg"},listeners:{exception:function(r,s,q){}}}},features:[h],dockedItems:[{xtype:"toolbar",items:[{iconCls:"icon-application_form_add",text:"Создать",scope:this,handler:a},{iconCls:"icon-application_form_edit",text:"Изменить",scope:this,disabled:true,itemId:"edit",handler:d},{iconCls:"icon-application_form_delete",text:"Удалить",disabled:true,itemId:"delete",scope:this,handler:b},{iconCls:"icon-table_refresh",text:"Обновить",itemId:"bRefresh",scope:this,handler:e}]}],columns:[{text:"Тип права",width:200,dataIndex:"righttype_grid",sortable:true},{text:"Надпись",width:200,dataIndex:"caption",sortable:true},{text:"Код",width:200,dataIndex:"name",sortable:true},{text:"№ п/п",width:60,dataIndex:"sequence",sortable:true},{text:"Иконка",width:200,dataIndex:"theicon",sortable:true},{text:"Это отчет",width:80,dataIndex:"isreport_grid",sortable:true}],listeners:{itemdblclick:function(){d()},itemclick:function(r,q){f.down("#delete").setDisabled(false);f.down("#edit").setDisabled(false)},select:function(t,s,r,q){f.down("#delete").setDisabled(false);f.down("#edit").setDisabled(false)},selectionchange:function(r,q){f.down("#delete").setDisabled(q.length===0);f.down("#edit").setDisabled(q.length===0)}}});var g=Ext.create("Ext.grid.feature.Grouping",{groupByText:"Группировать по этому полю",showGroupsText:"Показать группировку"});var p;function m(q){if(q){Ext.Ajax.request({url:rootURL+"index.php/c_bp3app_modules/deleteRow",method:"POST",params:{bp3app_modulesid:q.get("bp3app_modulesid")}});p.store.remove(q)}}function l(){var q=p.getView().getSelectionModel().getSelection()[0];if(q){if(CheckOperation("bp3app.edit")!=0){Ext.Msg.show({title:"Удалить?",msg:"Удалить строку из базы данных?",buttons:Ext.Msg.YESNO,icon:Ext.window.MessageBox.QUESTION,fn:function(r,t,s){if(r=="yes"){m(s.selectedRow)}},caller:this,selectedRow:q})}else{Ext.MessageBox.show({title:"Контроль прав.",msg:"Удаление строк не разрешено!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}}}function k(){if(CheckOperation("bp3app.edit")!=0){var q=Ext.create("EditWindow_bp3app_modules");p.store.insert(0,new model_bp3app_modules());record=p.store.getAt(0);record.set("instanceid",p.instanceid);q.getComponent(0).setActiveRecord(record,p.instanceid);q.show()}else{Ext.MessageBox.show({title:"Контроль прав.",msg:"Создание строк не разрешено!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}}function o(){p.store.load({params:{instanceid:p.instanceid}})}function n(){var r=p.getView().getSelectionModel().getSelection()[0];if(r){if(CheckOperation("bp3app.edit")!=0){var q=Ext.create("EditWindow_bp3app_modules");q.getComponent(0).setActiveRecord(r,r.get("instanceid"));q.show()}else{Ext.MessageBox.show({title:"Контроль прав.",msg:"Изменение строк не разрешено!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}}}p=new Ext.grid.Panel({itemId:i,store:j,frame:true,instanceid:"",scroll:"both",autoScroll:true,width:600,features:[g],dockedItems:[{xtype:"toolbar",items:[{iconCls:"icon-application_form_add",text:"Создать",scope:this,handler:k},{iconCls:"icon-application_form_edit",text:"Изменить",scope:this,disabled:true,itemId:"edit",handler:n},{iconCls:"icon-application_form_delete",text:"Удалить",disabled:true,itemId:"delete",scope:this,handler:l},{iconCls:"icon-table_refresh",text:"Обновить",itemId:"bRefresh",scope:this,handler:o}]}],columns:[{text:"Меню",width:200,dataIndex:"topmenu_grid",sortable:true},{text:"Имя группы",width:200,dataIndex:"groupname",sortable:true},{text:"Надпись",width:200,dataIndex:"caption",sortable:true},{text:"Код модуля",width:200,dataIndex:"name",sortable:true},{text:"№ п/п",width:60,dataIndex:"sequence",sortable:true},{text:"Описание",width:200,dataIndex:"thecomment",sortable:true},{text:"Иконка",width:200,dataIndex:"theicon",sortable:true},{text:"Настраивать видимость",width:60,dataIndex:"customizevisibility_grid",sortable:true},{text:"Журнал",width:200,dataIndex:"journal_grid",sortable:true},{text:"ID Документа",width:200,dataIndex:"document",sortable:true},{text:"Вариант действия",width:60,dataIndex:"actiontype_grid",sortable:true},{text:"Тип документа",width:200,dataIndex:"objecttype_grid",sortable:true},{text:"Отчет",width:200,dataIndex:"report_grid",sortable:true}],bbar:f,listeners:{resize:function(u,v,r,t,s,q){f.setHeight(r*0.5)},render:function(q){q.store.on("load",function(t,s,r){if(t.count()>0){q.getSelectionModel().select(0)}})},itemdblclick:function(){n()},itemclick:function(r,q){p.down("#delete").setDisabled(false);p.down("#edit").setDisabled(false);f.instanceid=p.instanceid;f.parentid=q.get("bp3app_modulesid");f.store.load({params:{parentid:q.get("bp3app_modulesid")}})},selectionchange:function(s,r){p.down("#delete").setDisabled(r.length===0);p.down("#edit").setDisabled(r.length===0);var q=r[0];if(q){p.down("#grd_bp3app_oper").instanceid=p.instanceid;p.down("#grd_bp3app_oper").parentid=q.get("bp3app_modulesid");p.down("#grd_bp3app_oper").store.load({params:{parentid:q.get("bp3app_modulesid")}})}}}});return p}function DefineForms_bp3app_modules_(){Ext.define("Form_bp3app_modules",{extend:"Ext.form.Panel",alias:"widget.f_bp3app_modules",initComponent:function(){this.addEvents("create");Ext.apply(this,{activeRecord:null,defaultType:"textfield",x:0,fieldDefaults:{labelAlign:"top"},items:[{xtype:"panel",closable:false,title:"",preventHeader:true,id:"bp3app_modules-0",layout:"absolute",border:false,items:[{minWidth:740,width:740,maxWidth:740,x:5,y:0,xtype:"combobox",trigger1Cls:"x-form-select-trigger",hideTrigger1:false,onTrigger1Click:function(){if(this.isExpanded){this.collapse()}else{if(this.store.count(false)==0){this.store.load()}this.expand()}},editable:false,listeners:{select:function(a,c,b){a.up("form").activeRecord.set("topmenu",c[0].get("id"))}},store:cmbstore_bp3app_menu,valueField:"brief",displayField:"brief",typeAhead:true,emptyText:"",name:"topmenu_grid",itemId:"topmenu_grid",fieldLabel:"Меню",labelClsExtra:"x-item-mandatory",allowBlank:false,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:46,xtype:"textfield",value:"",name:"groupname",itemId:"groupname",fieldLabel:"Имя группы",allowBlank:true,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:92,xtype:"textfield",value:"",name:"caption",itemId:"caption",fieldLabel:"Надпись",labelClsExtra:"x-item-mandatory",allowBlank:false,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:138,xtype:"textfield",value:"",name:"name",itemId:"name",fieldLabel:"Код модуля",labelClsExtra:"x-item-mandatory",allowBlank:false,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:184,xtype:"numberfield",value:"0",name:"sequence",itemId:"sequence",fieldLabel:"№ п/п",labelClsExtra:"x-item-mandatory",allowBlank:false,labelWidth:120},{minWidth:740,width:740,xtype:"textarea",x:5,y:230,height:80,xtype:"textarea",value:"",name:"thecomment",itemId:"thecomment",fieldLabel:"Описание",allowBlank:true,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:320,xtype:"textfield",value:"",name:"theicon",itemId:"theicon",fieldLabel:"Иконка",allowBlank:true,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:366,xtype:"combobox",editable:false,store:enum_Boolean,valueField:"name",displayField:"name",typeAhead:true,queryMode:"local",emptyText:"",name:"customizevisibility_grid",itemId:"customizevisibility_grid",listeners:{select:function(a,c,b){a.up("form").activeRecord.set("customizevisibility",c[0].get("value"))}},fieldLabel:"Настраивать видимость",labelClsExtra:"x-item-mandatory",allowBlank:false,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:412,xtype:"combobox",trigger1Cls:"x-form-clear-trigger",trigger2Cls:"x-form-select-trigger",hideTrigger1:false,hideTrigger2:false,onTrigger1Click:function(){this.collapse();this.clearValue();this.up("form").activeRecord.set("journal",null)},onTrigger2Click:function(){if(this.isExpanded){this.collapse()}else{if(this.store.count(false)==0){this.store.load()}this.expand()}},editable:false,listeners:{select:function(a,c,b){a.up("form").activeRecord.set("journal",c[0].get("id"))}},store:cmbstore_bp3list_def,valueField:"brief",displayField:"brief",typeAhead:true,emptyText:"",name:"journal_grid",itemId:"journal_grid",fieldLabel:"Журнал",allowBlank:true,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:458,xtype:"textfield",value:"",name:"document",itemId:"document",fieldLabel:"ID Документа",allowBlank:true,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:504,xtype:"combobox",editable:false,store:enum_MenuActionType,valueField:"name",displayField:"name",typeAhead:true,queryMode:"local",emptyText:"",name:"actiontype_grid",itemId:"actiontype_grid",listeners:{select:function(a,c,b){a.up("form").activeRecord.set("actiontype",c[0].get("value"))}},fieldLabel:"Вариант действия",labelClsExtra:"x-item-mandatory",allowBlank:false,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:550,xtype:"combobox",trigger1Cls:"x-form-clear-trigger",trigger2Cls:"x-form-select-trigger",hideTrigger1:false,hideTrigger2:false,onTrigger1Click:function(){this.collapse();this.clearValue();this.up("form").activeRecord.set("objecttype",null)},onTrigger2Click:function(){if(this.isExpanded){this.collapse()}else{if(this.store.count(false)==0){this.store.load()}this.expand()}},editable:false,listeners:{select:function(a,c,b){a.up("form").activeRecord.set("objecttype",c[0].get("id"))}},store:cmbstore_bp3doc_def,valueField:"brief",displayField:"brief",typeAhead:true,emptyText:"",name:"objecttype_grid",itemId:"objecttype_grid",fieldLabel:"Тип документа",allowBlank:true,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:596,xtype:"combobox",trigger1Cls:"x-form-clear-trigger",trigger2Cls:"x-form-select-trigger",hideTrigger1:false,hideTrigger2:false,onTrigger1Click:function(){this.collapse();this.clearValue();this.up("form").activeRecord.set("report",null)},onTrigger2Click:function(){if(this.isExpanded){this.collapse()}else{if(this.store.count(false)==0){this.store.load()}this.expand()}},editable:false,listeners:{select:function(a,c,b){a.up("form").activeRecord.set("report",c[0].get("id"))}},store:cmbstore_bp3report_def,valueField:"brief",displayField:"brief",typeAhead:true,emptyText:"",name:"report_grid",itemId:"report_grid",fieldLabel:"Отчет",allowBlank:true,labelWidth:120}],width:770,height:672}],instanceid:"",dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",items:["->",{iconCls:"icon-accept",itemId:"save",text:"Сохранить",disabled:true,scope:this,handler:this.onSave},{iconCls:"icon-cancel",text:"Закрыть",scope:this,handler:this.onReset}]}]});this.callParent()},setActiveRecord:function(b,a){this.activeRecord=b;this.instanceid=a;if(b){this.down("#save").enable();this.getForm().loadRecord(b)}else{this.down("#save").disable();this.getForm().reset()}},onSave:function(){var a=this.activeRecord,b=this.getForm();if(!a){return}if(b.isValid()){b.updateRecord(a);StatusDB("Сохранение данных");Ext.Ajax.request({url:rootURL+"index.php/c_bp3app_modules/setRow",method:"POST",params:{instanceid:this.instanceid,bp3app_modulesid:a.get("bp3app_modulesid"),topmenu:a.get("topmenu"),groupname:a.get("groupname"),caption:a.get("caption"),name:a.get("name"),sequence:a.get("sequence"),thecomment:a.get("thecomment"),theicon:a.get("theicon"),customizevisibility:a.get("customizevisibility"),journal:a.get("journal"),document:a.get("document"),actiontype:a.get("actiontype"),objecttype:a.get("objecttype"),report:a.get("report")},success:function(d){var e=d.responseText;var c=Ext.decode(e);if(c.success==false){Ext.MessageBox.show({title:"Ошибка",msg:c.msg,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});StatusErr("Ошибка. "+c.msg)}else{if(a.get("bp3app_modulesid")==""){a.set("bp3app_modulesid",c.data.bp3app_modulesid)}StatusReady("Изменения сохранены");b.owner.ownerCt.close()}}})}else{Ext.MessageBox.show({title:"Ошибка",msg:"Не все обязательные поля заполнены!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}},onReset:function(){if(this.activeRecord.get("bp3app_modulesid")==""){this.activeRecord.store.reload()}this.setActiveRecord(null,null);this.ownerCt.close()}});Ext.define("EditWindow_bp3app_modules",{extend:"Ext.window.Window",maxHeight:777,maxWidth:900,autoScroll:true,minWidth:750,width:800,minHeight:670,height:670,constrainHeader:true,layout:"absolute",autoShow:true,modal:true,closable:false,closeAction:"destroy",iconCls:"icon-application_form",title:"Модули",items:[{xtype:"f_bp3app_modules"}]});Ext.define("Form_bp3app_oper",{extend:"Ext.form.Panel",alias:"widget.f_bp3app_oper",initComponent:function(){this.addEvents("create");Ext.apply(this,{activeRecord:null,defaultType:"textfield",x:0,fieldDefaults:{labelAlign:"top"},items:[{xtype:"panel",closable:false,title:"",preventHeader:true,id:"bp3app_oper-0",layout:"absolute",border:false,items:[{minWidth:740,width:740,maxWidth:740,x:5,y:0,xtype:"combobox",trigger1Cls:"x-form-clear-trigger",trigger2Cls:"x-form-select-trigger",hideTrigger1:false,hideTrigger2:false,onTrigger1Click:function(){this.collapse();this.clearValue();this.up("form").activeRecord.set("righttype",null)},onTrigger2Click:function(){if(this.isExpanded){this.collapse()}else{if(this.store.count(false)==0){this.store.load()}this.expand()}},editable:false,listeners:{select:function(a,c,b){a.up("form").activeRecord.set("righttype",c[0].get("id"))}},store:cmbstore_bp3app_rigthtype,valueField:"brief",displayField:"brief",typeAhead:true,emptyText:"",name:"righttype_grid",itemId:"righttype_grid",fieldLabel:"Тип права",allowBlank:true,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:46,xtype:"textfield",value:"",name:"caption",itemId:"caption",fieldLabel:"Надпись",labelClsExtra:"x-item-mandatory",allowBlank:false,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:92,xtype:"textfield",value:"",name:"name",itemId:"name",fieldLabel:"Код",labelClsExtra:"x-item-mandatory",allowBlank:false,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:138,xtype:"numberfield",value:"0",name:"sequence",itemId:"sequence",fieldLabel:"№ п/п",labelClsExtra:"x-item-mandatory",allowBlank:false,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:184,xtype:"textfield",value:"",name:"theicon",itemId:"theicon",fieldLabel:"Иконка",allowBlank:true,labelWidth:120},{minWidth:740,width:740,maxWidth:740,x:5,y:230,xtype:"combobox",editable:false,store:enum_Boolean,valueField:"name",displayField:"name",typeAhead:true,queryMode:"local",emptyText:"",name:"isreport_grid",itemId:"isreport_grid",listeners:{select:function(a,c,b){a.up("form").activeRecord.set("isreport",c[0].get("value"))}},fieldLabel:"Это отчет",labelClsExtra:"x-item-mandatory",allowBlank:false,labelWidth:120}],width:770,height:306}],instanceid:"",dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",items:["->",{iconCls:"icon-accept",itemId:"save",text:"Сохранить",disabled:true,scope:this,handler:this.onSave},{iconCls:"icon-cancel",text:"Закрыть",scope:this,handler:this.onReset}]}]});this.callParent()},setActiveRecord:function(c,a,b){this.activeRecord=c;this.instanceid=a;this.parentid=b;if(c){this.down("#save").enable();this.getForm().loadRecord(c)}else{this.down("#save").disable();this.getForm().reset()}},onSave:function(){var a=this.activeRecord,b=this.getForm();if(!a){return}if(b.isValid()){b.updateRecord(a);StatusDB("Сохранение данных");Ext.Ajax.request({url:rootURL+"index.php/c_bp3app_oper/setRow",method:"POST",params:{instanceid:this.instanceid,parentid:this.parentid,bp3app_operid:a.get("bp3app_operid"),righttype:a.get("righttype"),caption:a.get("caption"),name:a.get("name"),sequence:a.get("sequence"),theicon:a.get("theicon"),isreport:a.get("isreport")},success:function(d){var e=d.responseText;var c=Ext.decode(e);if(c.success==false){Ext.MessageBox.show({title:"Ошибка",msg:c.msg,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});StatusErr("Ошибка. "+c.msg)}else{if(a.get("bp3app_operid")==""){a.set("bp3app_operid",c.data.bp3app_operid)}StatusReady("Изменения сохранены");b.owner.ownerCt.close()}}})}else{Ext.MessageBox.show({title:"Ошибка",msg:"Не все обязательные поля заполнены!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}},onReset:function(){if(this.activeRecord.get("bp3app_operid")==""){this.activeRecord.store.reload()}this.setActiveRecord(null,null);this.ownerCt.close()}});Ext.define("EditWindow_bp3app_oper",{extend:"Ext.window.Window",maxHeight:411,maxWidth:900,autoScroll:true,minWidth:750,width:800,minHeight:381,height:381,constrainHeader:true,layout:"absolute",autoShow:true,modal:true,closable:false,closeAction:"destroy",iconCls:"icon-application_form",title:"Действия и отчеты",items:[{xtype:"f_bp3app_oper"}]})};